# v0.4.0 Plan: Pluggable Source Adapters

## Objective

Introduce a source-adapter architecture for diagram ingestion (`rest` and `mcp`) while preserving existing Mermaid output behavior and CLI defaults.

## Milestones and Progress

1. Source adapter scaffold
- Status: Complete
- Added canonical graph/document typing.
- Added `DiagramSource` interface and source-mode selection (`rest | mcp | auto`).
- Added `FigmaRestSource` for existing REST ingestion.

2. Pipeline split with minimal churn
- Status: Complete
- Introduced explicit stages: `ingest -> normalize -> transform -> render`.
- Kept parser and Mermaid renderer behavior intact.

3. MCP transport + normalization baseline
- Status: Complete
- Implemented HTTP MCP transport contract (`McpHttpClient`) with env/constructor config:
  - `JAMAID_MCP_ENDPOINT_URL`
  - `JAMAID_MCP_AUTH_TOKEN`
  - `JAMAID_MCP_TIMEOUT_MS`
- Wired `FigmaMcpSource` to use MCP transport and return typed MCP ingested payload.
- Implemented initial MCP normalizer mapping for minimal contract:
  - `fileName?`
  - `pages[]`
  - `page.diagram.{nodes,edges,sections,stickyNotes}`
- Added readable validation errors for malformed MCP payloads.
- Preserved safe behavior:
  - `--source mcp` fails clearly when endpoint is not configured.
  - `--source auto` falls back to REST when MCP endpoint is unavailable.

4. User-facing docs + validation
- Status: Complete
- Documented MCP env vars and payload contract in README.
- Added test coverage for MCP source behavior and MCP normalizer mapping.
- Updated changelog and plan documentation.

## Remaining Risks

- MCP server implementations may return schema variants; normalization currently enforces a minimal strict shape and may require backward-compatible extensions in v0.4.x.
- `auto` fallback intentionally only handles MCP endpoint-unavailable cases. Broader fallback rules (network/server failures) are deferred until production MCP behavior is known.
- MCP contract currently assumes request/response over single HTTP POST; future streaming or multi-step MCP workflows may require transport evolution.

## Acceptance Criteria

- CLI accepts `--source rest|mcp|auto`.
- Default behavior remains REST when `--source` is omitted.
- `--source auto` falls back to REST when MCP endpoint is unavailable.
- Explicit `--source mcp` fails with a clear actionable error when MCP endpoint is missing.
- MCP payload can be normalized and rendered through the existing Mermaid pipeline.
- TypeScript typecheck, tests, and build pass.
